name: CI/CD Pipeline

on:
  pull_request:
    branches: [main, staging]
  push:
    branches: [main, staging]

jobs:
  ci-test:
    name: CI Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Install testing and linting tools
          pip install black flake8 pytest pytest-cov

      - name: Check code formatting with black
        run: |
          black --check --diff . || {
            echo "⚠️ Code formatting check found issues"
            echo "Run 'black .' to fix formatting issues"
            echo "Note: This is currently a warning, not blocking CI"
            exit 0
          }

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run unit tests with pytest
        run: |
          pytest --verbose --tb=short --cov=. --cov-report=term-missing --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  security-scan:
    name: Security Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Validate risk parameters
        run: |
          python scripts/validate_risk_params.py

      - name: Run safety suite
        run: |
          python -m validation.safety_suite || echo "⚠️ Warning: safety_suite validation had issues"

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."
          # Check for common secret patterns (API keys, tokens, passwords)
          if grep -r -i -E "(api[_-]?key|api[_-]?secret|password|token|secret[_-]?key)" --include="*.py" --include="*.yaml" --include="*.json" . | grep -v -E "(test_|example|\.example\.|_comment|description)" | grep -v "\.git/"; then
            echo "❌ Potential hardcoded secrets found!"
            echo "Please use environment variables or config files (excluded from git)"
            exit 1
          else
            echo "✅ No obvious hardcoded secrets detected"
          fi

      - name: Verify live trading is disabled
        run: |
          echo "Verifying live trading safety gates..."
          # Check trading_mode.yaml
          if grep -q "allow_live_trading: true" config/trading_mode.yaml 2>/dev/null; then
            echo "⚠️ WARNING: Live trading is enabled in trading_mode.yaml"
            echo "This should only be enabled in production with proper safeguards"
          else
            echo "✅ Live trading is disabled (safe default)"
          fi
          # Check for mode: live without proper gates
          if grep -q 'mode: "live"' config/trading_mode.yaml 2>/dev/null; then
            if ! grep -q "allow_live_trading: true" config/trading_mode.yaml 2>/dev/null; then
              echo "✅ Live mode set but allow_live_trading is false (safe)"
            fi
          fi

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    # Only run integration tests on PRs to main branch
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-asyncio

      - name: Run integration tests
        run: |
          # Run integration tests with specific marker
          pytest -v -m "integration or slow" || {
            echo "ℹ️ No integration tests found or tests failed"
            exit 0
          }

      - name: Run smoke backtest
        run: |
          # Run quick smoke test backtest if config exists
          if [ -f config/smoke_test.yaml ]; then
            python -m backtests.config_backtest --config config/smoke_test.yaml || {
              echo "⚠️ Smoke backtest failed or not available"
              exit 0
            }
          else
            echo "ℹ️ No smoke test configuration found, skipping"
          fi

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [ci-test, security-scan]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "==================================================================="
          echo "CI/CD VALIDATION SUMMARY"
          echo "==================================================================="
          echo ""
          echo "CI Test Suite: ${{ needs.ci-test.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo ""
          
          if [ "${{ needs.ci-test.result }}" != "success" ] || [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "❌ VALIDATION FAILED"
            echo ""
            echo "One or more required checks failed."
            echo "Please review the logs above and fix the issues."
            exit 1
          else
            echo "✅ ALL VALIDATIONS PASSED"
            echo ""
            echo "Code is ready for review and merge."
          fi
